#!/bin/bash
set -euo pipefail

SOURCE_DIR="/Users/{{ vm_name }}/{{ signal_cli_data_dir }}"
DEST_DIR="{{ signal_cli_payload_mount }}"
DEST_MARKER_FILE="${DEST_DIR}/{{ signal_cli_payload_marker_filename }}"
DEST_MARKER_BASENAME="{{ signal_cli_payload_marker_filename }}"
SYNC_INTERVAL_SECONDS="{{ signal_cli_payload_sync_interval_seconds }}"
MAX_CONSECUTIVE_FAILURES="{{ signal_cli_payload_sync_max_consecutive_failures }}"

log() {
  /bin/echo "$(/bin/date -u '+%Y-%m-%dT%H:%M:%SZ') [signal-cli-sync] $*"
}

sync_once() {
  if [ ! -d "$SOURCE_DIR" ] || [ ! -d "$DEST_DIR" ]; then
    log "skip: source or destination missing (source=${SOURCE_DIR} dest=${DEST_DIR})"
    return 0
  fi

  if [ ! -f "$DEST_MARKER_FILE" ]; then
    log "skip: destination marker missing (${DEST_MARKER_FILE})"
    return 0
  fi

  local rc=0
  if /usr/bin/rsync -a --no-perms --no-owner --no-group --delete --omit-dir-times --exclude="$DEST_MARKER_BASENAME" "$SOURCE_DIR/" "$DEST_DIR/"; then
    return 0
  else
    rc=$?
  fi
  if [ "$rc" -eq 24 ]; then
    return 0
  fi
  log "rsync failed (rc=${rc})"
  return "$rc"
}

sync_with_tracking() {
  if sync_once; then
    consecutive_failures=0
    return 0
  fi

  consecutive_failures=$((consecutive_failures + 1))
  log "consecutive failures: ${consecutive_failures}/${MAX_CONSECUTIVE_FAILURES}"
  if [ "$consecutive_failures" -ge "$MAX_CONSECUTIVE_FAILURES" ]; then
    log "too many consecutive failures; exiting for launchd restart"
    exit 1
  fi
  return 1
}

final_flush() {
  local attempt
  for attempt in 1 2 3; do
    if sync_once; then
      log "final sync succeeded"
      return 0
    fi
    /bin/sleep 1
  done
  log "final sync failed after 3 attempts"
  return 1
}

handle_shutdown() {
  final_flush || true
  exit 0
}

trap handle_shutdown TERM INT

consecutive_failures=0
sync_with_tracking || true
while true; do
  /bin/sleep "${SYNC_INTERVAL_SECONDS}"
  sync_with_tracking || true
done
