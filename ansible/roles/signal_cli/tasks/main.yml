---
- name: Install signal-cli via Homebrew
  become_user: "{{ vm_name }}"
  community.general.homebrew:
    name: signal-cli
    state: present
  environment:
    PATH: "{{ clawbox_brew_env_path }}"

- name: Ensure signal-cli data parent directory exists
  become_user: "{{ vm_name }}"
  file:
    path: "/Users/{{ vm_name }}/.local/share"
    state: directory

- name: Ensure signal-cli payload mount exists when payload mode is enabled
  stat:
    path: "{{ signal_cli_payload_mount }}"
  register: signal_cli_payload_mount_stat
  when: clawbox_enable_signal_payload | bool

- name: Fail when signal-cli payload mount is missing
  fail:
    msg: >-
      Expected signal-cli payload mount at {{ signal_cli_payload_mount }}.
      Launch the VM with --signal-cli-payload <path>.
  when:
    - clawbox_enable_signal_payload | bool
    - not signal_cli_payload_mount_stat.stat.exists

- name: Ensure signal-cli payload marker exists when payload mode is enabled
  stat:
    path: "{{ signal_cli_payload_mount }}/{{ signal_cli_payload_marker_filename }}"
  register: signal_cli_payload_marker_stat
  when: clawbox_enable_signal_payload | bool

- name: Fail when signal-cli payload marker is missing
  fail:
    msg: >-
      Expected signal-cli payload marker at
      {{ signal_cli_payload_mount }}/{{ signal_cli_payload_marker_filename }}.
      This guard prevents destructive payload seeding when the shared payload mount
      is not attached correctly. Launch with --signal-cli-payload <path> and retry.
  when:
    - clawbox_enable_signal_payload | bool
    - not signal_cli_payload_marker_stat.stat.exists

- name: Ensure local signal-cli data directory exists
  become_user: "{{ vm_name }}"
  file:
    path: "/Users/{{ vm_name }}/{{ signal_cli_data_dir }}"
    state: directory

- name: Seed local signal-cli data from payload mount when enabled
  become_user: "{{ vm_name }}"
  command:
    argv:
      - /usr/bin/rsync
      - -a
      - --delete
      - --itemize-changes
      - "--exclude={{ signal_cli_payload_marker_filename }}"
      - "{{ signal_cli_payload_mount }}/"
      - "/Users/{{ vm_name }}/{{ signal_cli_data_dir }}/"
  register: signal_cli_payload_seed_sync
  changed_when: (signal_cli_payload_seed_sync.stdout | trim) != ""
  when: clawbox_enable_signal_payload | bool

- name: Ensure signal-cli payload sync tooling directory exists
  become: true
  file:
    path: "{{ signal_cli_payload_sync_tooling_dir }}"
    state: directory
    mode: "0755"
  when: clawbox_enable_signal_payload | bool

- name: Install signal-cli payload sync script
  become: true
  template:
    src: sync-signal-cli-payload.sh.j2
    dest: "{{ signal_cli_payload_sync_script_path }}"
    mode: "0755"
  when: clawbox_enable_signal_payload | bool

- name: Install signal-cli payload sync LaunchDaemon
  become: true
  template:
    src: com.clawbox.signal-cli-payload-sync.plist.j2
    dest: "/Library/LaunchDaemons/{{ signal_cli_payload_sync_launchd_label }}.plist"
    mode: "0644"
  when: clawbox_enable_signal_payload | bool

- name: Unload signal-cli payload sync LaunchDaemon before reload
  become: true
  command: launchctl bootout "system/{{ signal_cli_payload_sync_launchd_label }}"
  failed_when: false
  changed_when: false
  when: clawbox_enable_signal_payload | bool

- name: Load signal-cli payload sync LaunchDaemon
  become: true
  command:
    argv:
      - launchctl
      - bootstrap
      - system
      - "/Library/LaunchDaemons/{{ signal_cli_payload_sync_launchd_label }}.plist"
  when: clawbox_enable_signal_payload | bool

- name: Kickstart signal-cli payload sync LaunchDaemon
  become: true
  command: launchctl kickstart -k "system/{{ signal_cli_payload_sync_launchd_label }}"
  when: clawbox_enable_signal_payload | bool

- name: Note signal-cli payload mode behavior
  debug:
    msg: >-
      signal-cli payload mode seeds {{ signal_cli_data_dir }} from {{ signal_cli_payload_mount }}
      at provision time and keeps it synced back to the host payload with a background LaunchDaemon
      every {{ signal_cli_payload_sync_interval_seconds }}s.
  when: clawbox_enable_signal_payload | bool
