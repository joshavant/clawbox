---
- name: Install signal-cli via Homebrew
  become_user: "{{ vm_name }}"
  community.general.homebrew:
    name: signal-cli
    state: present
  environment:
    PATH: "{{ clawbox_brew_env_path }}"

- name: Ensure signal-cli data parent directory exists
  become_user: "{{ vm_name }}"
  file:
    path: "/Users/{{ vm_name }}/.local/share"
    state: directory

- name: Ensure signal-cli payload sync path exists when payload mode is enabled
  stat:
    path: "{{ signal_cli_payload_mount }}"
  register: signal_cli_payload_mount_stat
  when: clawbox_enable_signal_payload | bool

- name: Fail when signal-cli payload sync path is missing
  fail:
    msg: >-
      Expected signal-cli payload sync path at {{ signal_cli_payload_mount }}.
      Launch the VM with --signal-cli-payload <path>.
  when:
    - clawbox_enable_signal_payload | bool
    - not signal_cli_payload_mount_stat.stat.exists

- name: Ensure signal-cli payload marker exists when payload mode is enabled
  stat:
    path: "{{ signal_cli_payload_mount }}/{{ signal_cli_payload_marker_filename }}"
  register: signal_cli_payload_marker_stat
  when: clawbox_enable_signal_payload | bool

- name: Fail when signal-cli payload marker is missing
  fail:
    msg: >-
      Expected signal-cli payload marker at
      {{ signal_cli_payload_mount }}/{{ signal_cli_payload_marker_filename }}.
      This guard prevents destructive payload seeding when the shared payload sync path
      is not attached correctly. Launch with --signal-cli-payload <path> and retry.
  when:
    - clawbox_enable_signal_payload | bool
    - not signal_cli_payload_marker_stat.stat.exists

- name: Inspect local signal-cli data path when payload mode is enabled
  become_user: "{{ vm_name }}"
  stat:
    path: "/Users/{{ vm_name }}/{{ signal_cli_data_dir }}"
    follow: false
  register: signal_cli_data_path_stat
  when: clawbox_enable_signal_payload | bool

- name: Preserve existing local signal-cli data in synced payload path before linking
  become_user: "{{ vm_name }}"
  command:
    argv:
      - /usr/bin/rsync
      - -a
      - --itemize-changes
      - "--exclude={{ signal_cli_payload_marker_filename }}"
      - "/Users/{{ vm_name }}/{{ signal_cli_data_dir }}/"
      - "{{ signal_cli_payload_mount }}/"
  register: signal_cli_payload_migration_sync
  changed_when: (signal_cli_payload_migration_sync.stdout | trim) != ""
  when:
    - clawbox_enable_signal_payload | bool
    - signal_cli_data_path_stat.stat.exists
    - not (signal_cli_data_path_stat.stat.islnk | default(false))
    - signal_cli_data_path_stat.stat.isdir | default(false)

- name: Remove non-symlink local signal-cli data path before linking
  become_user: "{{ vm_name }}"
  file:
    path: "/Users/{{ vm_name }}/{{ signal_cli_data_dir }}"
    state: absent
  when:
    - clawbox_enable_signal_payload | bool
    - signal_cli_data_path_stat.stat.exists
    - not (signal_cli_data_path_stat.stat.islnk | default(false))

- name: Ensure local signal-cli data path links to synced payload path when payload mode is enabled
  become_user: "{{ vm_name }}"
  file:
    src: "{{ signal_cli_payload_mount }}"
    dest: "/Users/{{ vm_name }}/{{ signal_cli_data_dir }}"
    state: link
    force: true
  when: clawbox_enable_signal_payload | bool

- name: Ensure local signal-cli data directory exists when payload mode is disabled
  become_user: "{{ vm_name }}"
  file:
    path: "/Users/{{ vm_name }}/{{ signal_cli_data_dir }}"
    state: directory
  when: not (clawbox_enable_signal_payload | bool)

- name: Unload legacy signal-cli payload sync LaunchDaemon
  become: true
  command: launchctl bootout "system/com.clawbox.signal-cli-payload-sync"
  failed_when: false
  changed_when: false
  when: clawbox_enable_signal_payload | bool

- name: Remove legacy signal-cli payload sync LaunchDaemon plist
  become: true
  file:
    path: "/Library/LaunchDaemons/com.clawbox.signal-cli-payload-sync.plist"
    state: absent
  when: clawbox_enable_signal_payload | bool

- name: Remove legacy signal-cli payload sync script
  become: true
  file:
    path: "/Library/Clawbox/sync-signal-cli-payload.sh"
    state: absent
  when: clawbox_enable_signal_payload | bool

- name: Note signal-cli payload mode behavior
  debug:
    msg: >-
      signal-cli payload mode links /Users/{{ vm_name }}/{{ signal_cli_data_dir }} to
      {{ signal_cli_payload_mount }} and relies on Mutagen bidirectional sync for host/VM updates.
  when: clawbox_enable_signal_payload | bool
